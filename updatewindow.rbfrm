#tag WindowBegin Window updatewindow   BackColor       =   16777215   Backdrop        =   ""   CloseButton     =   True   Composite       =   True   Frame           =   8   FullScreen      =   False   HasBackColor    =   False   Height          =   211   ImplicitInstance=   True   LiveResize      =   True   MacProcID       =   0   MaxHeight       =   32000   MaximizeButton  =   False   MaxWidth        =   32000   MenuBar         =   ""   MenuBarVisible  =   True   MinHeight       =   64   MinimizeButton  =   True   MinWidth        =   64   Placement       =   0   Resizeable      =   True   Title           =   "Untitled"   Visible         =   True   Width           =   532   Begin StaticText seriestitle      AutoDeactivate  =   True      Bold            =   True      DataField       =   ""      DataSource      =   ""      Enabled         =   True      Height          =   29      HelpTag         =   ""      Index           =   -2147483648      InitialParent   =   ""      Italic          =   ""      Left            =   20      LockBottom      =   ""      LockedInPosition=   False      LockLeft        =   ""      LockRight       =   ""      LockTop         =   ""      Multiline       =   True      Scope           =   0      TabIndex        =   0      TabPanelIndex   =   0      Text            =   ""      TextAlign       =   0      TextColor       =   0      TextFont        =   "System"      TextSize        =   0      TextUnit        =   0      Top             =   11      Underline       =   ""      Visible         =   True      Width           =   492   End   Begin PopupMenu status      AutoDeactivate  =   True      Bold            =   ""      DataField       =   ""      DataSource      =   ""      Enabled         =   True      Height          =   20      HelpTag         =   ""      Index           =   -2147483648      InitialParent   =   ""      InitialValue    =   "watching\rcompleted\ron-hold\rdropped\rplan to watch"      Italic          =   ""      Left            =   121      ListIndex       =   0      LockBottom      =   ""      LockedInPosition=   False      LockLeft        =   ""      LockRight       =   ""      LockTop         =   ""      Scope           =   0      TabIndex        =   1      TabPanelIndex   =   0      TabStop         =   True      TextFont        =   "System"      TextSize        =   0      TextUnit        =   0      Top             =   45      Underline       =   ""      Visible         =   True      Width           =   159   End   Begin StaticText StaticText2      AutoDeactivate  =   True      Bold            =   ""      DataField       =   ""      DataSource      =   ""      Enabled         =   True      Height          =   20      HelpTag         =   ""      Index           =   -2147483648      InitialParent   =   ""      Italic          =   ""      Left            =   20      LockBottom      =   ""      LockedInPosition=   False      LockLeft        =   ""      LockRight       =   ""      LockTop         =   ""      Multiline       =   ""      Scope           =   0      TabIndex        =   3      TabPanelIndex   =   0      Text            =   "Status:"      TextAlign       =   0      TextColor       =   0      TextFont        =   "System"      TextSize        =   0      TextUnit        =   0      Top             =   45      Underline       =   ""      Visible         =   True      Width           =   100   End   Begin StaticText StaticText3      AutoDeactivate  =   True      Bold            =   ""      DataField       =   ""      DataSource      =   ""      Enabled         =   True      Height          =   20      HelpTag         =   ""      Index           =   -2147483648      InitialParent   =   ""      Italic          =   ""      Left            =   20      LockBottom      =   ""      LockedInPosition=   False      LockLeft        =   ""      LockRight       =   ""      LockTop         =   ""      Multiline       =   ""      Scope           =   0      TabIndex        =   4      TabPanelIndex   =   0      Text            =   "Episodes:"      TextAlign       =   0      TextColor       =   0      TextFont        =   "System"      TextSize        =   0      TextUnit        =   0      Top             =   77      Underline       =   ""      Visible         =   True      Width           =   100   End   Begin TextField epiwatched      AcceptTabs      =   ""      Alignment       =   0      AutoDeactivate  =   True      BackColor       =   16777215      Bold            =   ""      Border          =   True      CueText         =   ""      DataField       =   ""      DataSource      =   ""      Enabled         =   True      Format          =   "##"      Height          =   22      HelpTag         =   ""      Index           =   -2147483648      InitialParent   =   ""      Italic          =   ""      Left            =   121      LimitText       =   0      LockBottom      =   ""      LockedInPosition=   False      LockLeft        =   ""      LockRight       =   ""      LockTop         =   ""      Mask            =   "###"      Password        =   ""      ReadOnly        =   ""      Scope           =   0      TabIndex        =   2      TabPanelIndex   =   0      TabStop         =   True      Text            =   ""      TextColor       =   0      TextFont        =   "System"      TextSize        =   0      TextUnit        =   0      Top             =   77      Underline       =   ""      UseFocusRing    =   True      Visible         =   True      Width           =   39   End   Begin StaticText StaticText4      AutoDeactivate  =   True      Bold            =   ""      DataField       =   ""      DataSource      =   ""      Enabled         =   True      Height          =   20      HelpTag         =   ""      Index           =   -2147483648      InitialParent   =   ""      Italic          =   ""      Left            =   20      LockBottom      =   ""      LockedInPosition=   False      LockLeft        =   ""      LockRight       =   ""      LockTop         =   ""      Multiline       =   ""      Scope           =   0      TabIndex        =   6      TabPanelIndex   =   0      Text            =   "Score"      TextAlign       =   0      TextColor       =   0      TextFont        =   "System"      TextSize        =   0      TextUnit        =   0      Top             =   110      Underline       =   ""      Visible         =   True      Width           =   100   End   Begin PopupMenu score      AutoDeactivate  =   True      Bold            =   ""      DataField       =   ""      DataSource      =   ""      Enabled         =   True      Height          =   20      HelpTag         =   ""      Index           =   -2147483648      InitialParent   =   ""      InitialValue    =   "0\r1\r2\r3\r4\r5\r6\r7\r8\r9\r10"      Italic          =   ""      Left            =   121      ListIndex       =   0      LockBottom      =   ""      LockedInPosition=   False      LockLeft        =   ""      LockRight       =   ""      LockTop         =   ""      Scope           =   0      TabIndex        =   4      TabPanelIndex   =   0      TabStop         =   True      TextFont        =   "System"      TextSize        =   0      TextUnit        =   0      Top             =   110      Underline       =   ""      Visible         =   True      Width           =   69   End   Begin PushButton updatebut      AutoDeactivate  =   True      Bold            =   ""      Cancel          =   ""      Caption         =   "Update"      Default         =   True      Enabled         =   True      Height          =   20      HelpTag         =   ""      Index           =   -2147483648      InitialParent   =   ""      Italic          =   ""      Left            =   432      LockBottom      =   ""      LockedInPosition=   False      LockLeft        =   ""      LockRight       =   ""      LockTop         =   ""      Scope           =   0      TabIndex        =   8      TabPanelIndex   =   0      TabStop         =   True      TextFont        =   "System"      TextSize        =   0      TextUnit        =   0      Top             =   175      Underline       =   ""      Visible         =   True      Width           =   80   End   Begin PushButton PushButton2      AutoDeactivate  =   True      Bold            =   ""      Cancel          =   True      Caption         =   "Cancel"      Default         =   ""      Enabled         =   True      Height          =   20      HelpTag         =   ""      Index           =   -2147483648      InitialParent   =   ""      Italic          =   ""      Left            =   340      LockBottom      =   ""      LockedInPosition=   False      LockLeft        =   ""      LockRight       =   ""      LockTop         =   ""      Scope           =   0      TabIndex        =   7      TabPanelIndex   =   0      TabStop         =   True      TextFont        =   "System"      TextSize        =   0      TextUnit        =   0      Top             =   175      Underline       =   ""      Visible         =   True      Width           =   80   End   Begin StaticText StaticText5      AutoDeactivate  =   True      Bold            =   ""      DataField       =   ""      DataSource      =   ""      Enabled         =   True      Height          =   20      HelpTag         =   ""      Index           =   -2147483648      InitialParent   =   ""      Italic          =   ""      Left            =   191      LockBottom      =   ""      LockedInPosition=   False      LockLeft        =   ""      LockRight       =   ""      LockTop         =   ""      Multiline       =   ""      Scope           =   0      TabIndex        =   10      TabPanelIndex   =   0      Text            =   "out of "      TextAlign       =   0      TextColor       =   0      TextFont        =   "System"      TextSize        =   0      TextUnit        =   0      Top             =   77      Underline       =   ""      Visible         =   True      Width           =   41   End   Begin HTTPSocket Socket1      Address         =   ""      Height          =   32      Index           =   -2147483648      Left            =   418      LockedInPosition=   False      Port            =   0      Scope           =   0      TabPanelIndex   =   0      Top             =   85      Width           =   32      yield           =   0   End   Begin ProgressWheel ProgressWheel1      AutoDeactivate  =   True      Enabled         =   True      Height          =   16      HelpTag         =   ""      Index           =   -2147483648      InitialParent   =   ""      Left            =   20      LockBottom      =   ""      LockedInPosition=   False      LockLeft        =   ""      LockRight       =   ""      LockTop         =   ""      Scope           =   0      TabIndex        =   13      TabPanelIndex   =   0      TabStop         =   True      Top             =   175      Visible         =   False      Width           =   16   End   Begin StaticText commentslbl      AutoDeactivate  =   True      Bold            =   ""      DataField       =   ""      DataSource      =   ""      Enabled         =   True      Height          =   20      HelpTag         =   ""      Index           =   -2147483648      InitialParent   =   ""      Italic          =   ""      Left            =   20      LockBottom      =   ""      LockedInPosition=   False      LockLeft        =   ""      LockRight       =   ""      LockTop         =   ""      Multiline       =   ""      Scope           =   0      TabIndex        =   14      TabPanelIndex   =   0      Text            =   "Comments:"      TextAlign       =   0      TextColor       =   0      TextFont        =   "System"      TextSize        =   0      TextUnit        =   0      Top             =   141      Underline       =   ""      Visible         =   False      Width           =   100   End   Begin TextField commentsfield      AcceptTabs      =   ""      Alignment       =   0      AutoDeactivate  =   True      BackColor       =   16777215      Bold            =   ""      Border          =   True      CueText         =   ""      DataField       =   ""      DataSource      =   ""      Enabled         =   True      Format          =   ""      Height          =   22      HelpTag         =   ""      Index           =   -2147483648      InitialParent   =   ""      Italic          =   ""      Left            =   121      LimitText       =   0      LockBottom      =   ""      LockedInPosition=   False      LockLeft        =   ""      LockRight       =   ""      LockTop         =   ""      Mask            =   ""      Password        =   ""      ReadOnly        =   ""      Scope           =   0      TabIndex        =   5      TabPanelIndex   =   0      TabStop         =   True      Text            =   ""      TextColor       =   0      TextFont        =   "System"      TextSize        =   0      TextUnit        =   0      Top             =   141      Underline       =   ""      UseFocusRing    =   True      Visible         =   False      Width           =   354   End   Begin PushButton EditMAL      AutoDeactivate  =   True      Bold            =   ""      Cancel          =   ""      Caption         =   "Edit on MAL"      Default         =   ""      Enabled         =   True      Height          =   20      HelpTag         =   ""      Index           =   -2147483648      InitialParent   =   ""      Italic          =   ""      Left            =   235      LockBottom      =   ""      LockedInPosition=   False      LockLeft        =   ""      LockRight       =   ""      LockTop         =   ""      Scope           =   0      TabIndex        =   6      TabPanelIndex   =   0      TabStop         =   True      TextFont        =   "System"      TextSize        =   0      TextUnit        =   0      Top             =   175      Underline       =   ""      Visible         =   True      Width           =   93   End   Begin UpDownArrows UpDownArrows1      AcceptFocus     =   False      AutoDeactivate  =   True      Enabled         =   True      Height          =   23      HelpTag         =   ""      Index           =   -2147483648      InitialParent   =   ""      Left            =   166      LockBottom      =   ""      LockedInPosition=   False      LockLeft        =   ""      LockRight       =   ""      LockTop         =   ""      Scope           =   0      TabIndex        =   3      TabPanelIndex   =   0      TabStop         =   True      Top             =   77      Visible         =   True      Width           =   13   End   Begin StaticText eptotal      AutoDeactivate  =   True      Bold            =   ""      DataField       =   ""      DataSource      =   ""      Enabled         =   True      Height          =   20      HelpTag         =   ""      Index           =   -2147483648      InitialParent   =   ""      Italic          =   ""      Left            =   240      LockBottom      =   ""      LockedInPosition=   False      LockLeft        =   ""      LockRight       =   ""      LockTop         =   ""      Multiline       =   ""      Scope           =   0      TabIndex        =   11      TabPanelIndex   =   0      Text            =   ""      TextAlign       =   0      TextColor       =   0      TextFont        =   "System"      TextSize        =   0      TextUnit        =   0      Top             =   77      Underline       =   ""      Visible         =   True      Width           =   43   EndEnd#tag EndWindow#tag WindowCode	#tag Event		Sub Open()		  If prefs.BooleanMelUpdates = true then		    commentsfield.visible = true		    commentslbl.visible = true		  end if		End Sub	#tag EndEvent	#tag Method, Flags = &h0		Sub addloadinfo()		  		  // load anime infomation		  dim data as string		  data= socket1.get("http://mal-api.com/anime/" + AniID  ,10)		  If data is nil then		    self.truewindow.hide		    app.errboxshowdialog("MAL Client OS X was not able to retrieve information and watch status on this title.", "Make sure your internet connection is working and try again.")		    self.truewindow.show		    updatebut.enabled = false		    seriestitle.text = "Unable to retrieve your status on the series you chosen to add"		  else		    // Parse JSON to Dictionary (d)		    d = json.parse(data)		    //Set Total Episodes		    If d.value("episodes") = "0" Then		      eptotal.text = "-"		    else		      eptotal.text = d.value("episodes")		    end if		    // Set Air Status		    anistatus = d.value("status")		    //clear data		    d = nil		    data = ""		    //Set Watched Episodes to 0		    epiwatched.text = "0"		    updatebut.caption = "Add"		    EditMAL.Enabled = false		  end if		End Sub	#tag EndMethod	#tag Method, Flags = &h0		Sub addseries()		  updatebut.enabled = false		  ProgressWheel1.visible = true		  updatebut.enabled = false		  Socket1.yield = true		  Dim form as Dictionary		  // create and populate the form object		  form = New Dictionary		  form.value("anime_id") = AniID		  form.value("status") = status.text		  form.value("episodes") = epiwatched.text		  form.value("score") = score.text		  // setup the socket to POST the form		  socket1.setFormData form		  socket1.setrequestheader "Authorization","Basic " + app.loginenc		  socket1.Post "http://mal-api.com/animelist/anime"		  If socket1.httpstatuscode = 200 then		    If prefs.BooleanMelUpdates = true then		      // Scrobble to Melative		      melpostupdate		    else		    end if		    doIt=true		    window1.refreshlist(true)		    hide		  else		    // Show Error		    app.errboxshowdialog("There was a problem when we were trying to add a title.", "Check your internet connection and try your update again.")		    updatebut.enabled = true		  end if		End Sub	#tag EndMethod	#tag Method, Flags = &h0		Sub loadinfo()		  // load anime infomation		  dim data as string		  socket1.setrequestheader "Authorization","Basic " + app.loginenc		  data= socket1.get("http://mal-api.com/anime/" + AniID + "?mine=1" ,10)		  If data is nil then		    self.truewindow.hide		    app.errboxshowdialog("MAL Client OS X was not able to retrieve information and watch status on this title.", "Make sure your internet connection is working and try again.")		    self.truewindow.show		    updatebut.enabled = false		    EditMAL.Enabled = false		    seriestitle.text = "Unable to retrieve your status on the series you chosen to update"		  else		    // Parse JSON to Dictionary (d)		    d = json.parse(data)		    //Set Total Episodes		    If d.value("episodes") = "0" Then		      eptotal.text = "-"		    else		      eptotal.text = d.value("episodes")		    end if		    //Set Status		    if d.value("watched_status") = "watching" then		    elseif d.value("watched_status")  ="completed" then		      status.listindex = 1		    elseif d.value("watched_status") = "dropped" then		      status.listindex = 3		    elseif d.value("watched_status") ="completed" then		      status.listindex = 4		    elseif d.value("watched_status") ="plan to watch" then		      status.listindex = 5		    else		      status.listindex =2		    End If		    // Set Watched Episodes		    epiwatched.text = d.value("watched_episodes")		    //Set Score		    If  d.value("score") is nil then		    else		      score.listindex = val(d.value("score"))		    end if		    // Set Air Status		    anistatus = d.value("status")		    // Set Listed Ani ID		    listedaniid = d.value("listed_anime_id")		    //clear data		    d = nil		    data = ""		  end if		End Sub	#tag EndMethod	#tag Method, Flags = &h0		Sub melpostupdate()		  dim data as string		  dim socket2 as new httpsocket		  // create and populate the form object		  dim form2 as New Dictionary		  		  dim s as string		  // Correct Scobbling Action for Melative		  If status.text = "plan to watch" then		    s = "wishlist"		  Elseif status.text = "on-hold" then		    s = "pause"		  Elseif status.text = "dropped" then		    s= "drop"		  Elseif  status.text = "watching" then		    s="watched"		  else		    s = status.text		  end if		  // Set content		  If Commentsfield.text = "" then		    If upmethod = "Update" then		      // Scobble Title Only		      form2.value("anime") = titleprob		      form2.value("segment") = epiwatched.text		      socket2.setFormData form2		      socket2.setrequestheader "Authorization","Basic " + prefs.StringMelAuth		      data = socket2.post("http://melative.com/api/library/segment/update.json",10)		    elseif upmethod = "Add" then		      form2.value("anime") = titleprob		      form2.value("state") = "current"		      socket2.setFormData form2		      socket2.setrequestheader "Authorization","Basic " + prefs.StringMelAuth		      data = socket2.post("http://melative.com/api/library/update.json",10)		    end if		  else		    // Use Normal Updating		    // Figure out the num of episodes. If zero, episode part will not be shown in the update		    If epiwatched.text = "0" then		      form2.value("message") = s + " /anime/" + titleprob + "/ : " + commentsfield.text		    else		      form2.value("message") = s + " /anime/" + titleprob + "/Episode "+ epiwatched.text + ": " + commentsfield.text		    end if		    // Set Client ( e.g. <username> in anime <time> ago from MAL Client OS X)		    form2.value("source") = "MAL Client OS X"		    // setup the socket to POST the form		    socket2.setFormData form2		    socket2.setrequestheader "Authorization","Basic " + prefs.StringMelAuth		    data = socket2.post("http://melative.com/api/micro/update.json",10)		  end if		  // release data from memory		  s = ""		  form2 = nil		End Sub	#tag EndMethod	#tag Method, Flags = &h0		Sub updateinfo()		  updatebut.enabled = false		  ProgressWheel1.visible = true		  socket1.yield = true		  updatebut.enabled = false		  Dim form as Dictionary		  dim t as boolean		  // create and populate the form object		  form = New Dictionary		  form.value("_method") = "PUT"		  form.value("status") = status.text		  form.value("episodes") = epiwatched.text		  form.value("score") = score.text		  // setup the socket to POST the form		  socket1.setFormData form		  socket1.setrequestheader "Authorization","Basic " + app.loginenc		  socket1.post ("http://mal-api.com/animelist/anime/" + AniID )		  If socket1.httpstatuscode = 200 then		    // if successful		    If prefs.BooleanMelUpdates = true then		      // Scrobble to Melative		      melpostupdate		    else		    end if		    doIt=true		    t = doit		    window1.refreshlist(true)		    hide		  else		    // Show Error		    app.errboxshowdialog("There was a problem when we were trying to update your status.", "Check your internet connection and try your update again.")		    updatebut.enabled = true		  end if		End Sub	#tag EndMethod	#tag Property, Flags = &h0		AniID As string	#tag EndProperty	#tag Property, Flags = &h0		anistatus As string	#tag EndProperty	#tag Property, Flags = &h0		d As dictionary	#tag EndProperty	#tag Property, Flags = &h0		doit As boolean = false	#tag EndProperty	#tag Property, Flags = &h0		listedaniid As string	#tag EndProperty	#tag Property, Flags = &h0		titleprob As string	#tag EndProperty	#tag Property, Flags = &h0		upmethod As string	#tag EndProperty#tag EndWindowCode#tag Events epiwatched	#tag Event		Function KeyDown(Key As String) As Boolean		  if instr("0123456789."+chr(28)+ chr(29)+ chr(30)+ chr(31)+chr(3)+chr(9)+chr(10)+chr(8),key)>-1 then		    // handle specific keys from our list		  else		    // ignore the key		    return true		  end		End Function	#tag EndEvent#tag EndEvents#tag Events updatebut	#tag Event		Sub Action()		  // Make sure you have valid update information		  If upmethod = "Update" then		    If anistatus = "Not yet aired" then		      If status.text = "plan to watch" and epiwatched.text = "0"  and score.text = "0" then		        updateinfo		      else		        app.errboxshowdialog("MAL Client OS X was unable to update your status since you selected a invalid watching status.", "You cannot set the status, score, or episodes to anything else but plan to watch since this series haven't aired yet.")		      end if		    Elseif anistatus = "currently airing" then		      If status.text = "completed" then		        app.errboxshowdialog("MAL Client OS X was unable to update your status since you selected a invalid watching status.", "You cannot set the status as completed since the series is still airing.")		      else		        If eptotal.text = "0" then		          updateinfo		        else		          If val(epiwatched.text) > val(eptotal.text)  then		            app.errboxshowdialog("MAL Client OS X was unable to update your status since you entered a invalid episode number.", "Enter a valid episode number and try updating again.")		          else		            updateinfo		          end if		        end if		      end if		    else		      If val(epiwatched.text) > val(eptotal.text)  then		        app.errboxshowdialog("MAL Client OS X was unable to update your status since you entered a invalid episode number.", "Enter a valid episode number and try updating again.")		      else		        updateinfo		      end if		    end if		  ElseIf upMethod = "Add" then		    If anistatus = "Not yet aired" then		      If status.text = "plan to watch" and epiwatched.text = "0"  and score.text = "0" then		        addseries		      else		        app.errboxshowdialog("MAL Client OS X was unable to add a new title since you selected a invalid watching status.", "You cannot set the status, score, or episodes to anything else but plan to watch since this series haven't aired yet.")		      end if		    Elseif anistatus = "currently airing" then		      If status.text = "completed" then		        app.errboxshowdialog("MAL Client OS X was unable to add a new title since you selected a invalid watching status.", "You cannot set the status as completed since the series is still airing.")		      else		        If eptotal.text = "0" then		          addseries		        else		          If val(epiwatched.text) > val(eptotal.text)  then		            app.errboxshowdialog("MAL Client OS X was unable to add a new title since you entered a invalid episode number.", "Enter a valid episode number and try updating again.")		          else		            addseries		          end if		        end if		      end if		    else		      If val(epiwatched.text) > val(eptotal.text)  then		        app.errboxshowdialog("MAL Client OS X was unable to add a new title since you entered a invalid episode number.", "Enter a valid episode number and try updating again.")		      else		        addseries		      end if		    end if		  end if		End Sub	#tag EndEvent#tag EndEvents#tag Events PushButton2	#tag Event		Sub Action()		  doIt=false		  hide		End Sub	#tag EndEvent#tag EndEvents#tag Events EditMAL	#tag Event		Sub Action()		  showurl "http://myanimelist.net/panel.php?go=edit&id=" + listedaniid		End Sub	#tag EndEvent#tag EndEvents#tag Events UpDownArrows1	#tag Event		Sub Down()		  if val(epiwatched.text) > 0 then		    epiwatched.text = cstr(val(epiwatched.text)-1)		  else		    beep		  end if		End Sub	#tag EndEvent	#tag Event		Sub Up()		  if val(epiwatched.text) < val(eptotal.text) then		    epiwatched.text = cstr(val(epiwatched.text)+1)		  else		    beep		  end if		End Sub	#tag EndEvent#tag EndEvents